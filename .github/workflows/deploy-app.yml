name: Phase 3 - Deploy the Placeholder App

on:
  push:
    branches:
      - master

jobs:
  deploy-app:
    runs-on: ubuntu-latest
    needs: ansible   # âœ… Links Phase 3 to Phase 1 (Terraform + Ansible)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up SSH key and known_hosts
        run: |
          echo "ðŸ” Setting up SSH"
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

      - name: Deploy Placeholder App via SSH into K3s
        run: |
          ssh -o StrictHostKeyChecking=no ubuntu@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
            echo "ðŸ“¦ Writing placeholder Kubernetes manifest..."
            cat << 'YAML' > ~/k8s.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: placeholder-app
spec:
  replicas: 1
  selector:
    matchLabels:
      app: placeholder
  template:
    metadata:
      labels:
        app: placeholder
    spec:
      containers:
        - name: placeholder
          image: cicd-placeholder-app:latest
          imagePullPolicy: IfNotPresent
          ports:
            - containerPort: 3000
---
apiVersion: v1
kind: Service
metadata:
  name: placeholder-service
spec:
  type: NodePort
  selector:
    app: placeholder
  ports:
    - port: 3000
      targetPort: 3000
      nodePort: 30080
YAML

            echo "ðŸš€ Applying manifest to K3s..."
            kubectl apply -f ~/k8s.yaml
            echo "âœ… App deployed on K3s!"
EOF
